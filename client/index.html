<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>MLCraft </title>
    <meta
            name="description"
            content="none yet"/>
    <script src="https://cdn.jsdelivr.net/gh/jerosoler/Drawflow/dist/drawflow.min.js"></script>
    <script
            src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/js/all.min.js"
            integrity="sha256-KzZiKy0DWYsnwMF+X1DvQngQ2/FxF7MF3Ff72XcpuPs="
            crossorigin="anonymous"
    ></script>
    <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/gh/jerosoler/Drawflow/dist/drawflow.min.css"/>
    <link
            rel="stylesheet"
            type="text/css"
            href="./style.css"/>
    <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css"
            integrity="sha256-h20CPZ0QyXlBuAw7A+KluUYx/3pK+c7lYEpqLTlxjYQ="
            crossorigin="anonymous"/>
    <link
            href="https://fonts.googleapis.com/css2?family=Roboto&display=swap"
            rel="stylesheet"/>
    <link
            href="https://fonts.googleapis.com/icon?family=Material+Icons"
            rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
    <script src="https://unpkg.com/micromodal/dist/micromodal.min.js"></script>
</head>
<body>



<!-- HTML parts -->
<div class="notification" id="error"> Error</div>
<div class="notification" id="success"> Success</div>


<header>
    <label class="button-wrapper">
        <input type="button" class="profile-check" onclick=showProfile()>
        <i class="material-icons" style="font-size:65px; position: relative; left:-7px; bottom: 2px" onmousedown="return false">person</i>
    </label>
    <h2 onmousedown="return false">MLCraft</h2>
    <div class="github-link">
        <a href="https://github.com/SPbuMinecraft/GraphicalEditorForNN" target="_blank"
        ><i class="fab fa-github fa-3x" style="color: var(--background3)"></i
        ></a>
    </div>
    <div class="menu" onmousedown="return false">
        <ul>
            <li id ="select-home" onclick="showMode(event); ">
                Home
            </li>
            <li id ="select-constructor" onclick="showMode(event);"
                class="selected">
                Constructor
            </li>
            <li id ="select-terminal" onclick="showMode(event);">
                Terminal
            </li>
            <li id ="select-metrics" onclick="showMode(event);">
                Metrics
            </li>
        </ul>
    </div>
</header>

<div class="profile" id="profile">
    Coming soon!
    <label class="day-night-mode-label">
        <input type="checkbox" id = "day-night-checkbox-id" class="day-night-checkbox" value="day" onclick=changeTheme()>
        <span class="control"></span>
    </label>
</div>

<div class="home" id="home">
    Coming soon!
</div>

<div class="constructor" id ="constructor">
    <div class="col">
        <div
                class="drag-drawflow"
                draggable="true"
                ondragstart="drag(event)"
                data-node="linear">
            <span> Linear</span>
        </div>
        <div
                class="drag-drawflow"
                draggable="true"
                ondragstart="drag(event)"
                data-node="relu">
            <span> ReLU</span>
        </div>

        <!--
        <div
                class="drag-drawflow"
                draggable="true"
                ondragstart="drag(event)"
                data-node="sigmoid">
            <span> Sigmoid</span>

        </div>
        -->

        <div
                class="drag-drawflow"
                draggable="false"
                onmousedown="return false">
            <span> Coming soon</span>
        </div> <br>

        <div class="predict-train-interface" id="train">
            <form class="predict-train-form" id="xy-form-train">
                <label for="x-value1" class="x-val-label"> x </label>
                <input type="text" class="form-control-x" id="x-value1" name="x">
                <label for="y-value1" class="y-val-label"> y </label>
                <input type="text" class="form-control-y" id="y-value1" name="y">
                <label for="res-value1" class="res-val-label"> = </label>
                <input type="text" class="form-control-res" id="res-value1" name="res"><br>

                <label for="x-value2" class="x-val-label"> x </label>
                <input type="text" class="form-control-x" id="x-value2" name="x">
                <label for="y-value2" class="y-val-label"> y </label>
                <input type="text" class="form-control-y" id="y-value2" name="y">
                <label for="res-value2" class="res-val-label"> =</label>
                <input type="text" class="form-control-res" id="res-value2" name="res"><br>

                <label for="x-value3" class="x-val-label"> x </label>
                <input type="text" class="form-control-x" id="x-value3" name="x">
                <label for="y-value3" class="y-val-label"> y </label>
                <input type="text" class="form-control-y" id="y-value3" name="y">
                <label for="res-value3" class="res-val-label"> =</label>
                <input type="text" class="form-control-res" id="res-value3" name="res"><br>

                <label for="x-value4" class="x-val-label"> x </label>
                <input type="text" class="form-control-x" id="x-value4" name="x">
                <label for="y-value4" class="y-val-label"> y </label>
                <input type="text" class="form-control-y" id="y-value4" name="y">
                <label for="res-value4" class="res-val-label"> =</label>
                <input type="text" class="form-control-res" id="res-value4" name="res"><br>

                <label for="x-value5" class="x-val-label"> x </label>
                <input type="text" class="form-control-x" id="x-value5" name="x">
                <label for="y-value5" class="y-val-label"> y </label>
                <input type="text" class="form-control-y" id="y-value5" name="y">
                <label for="res-value5" class="res-val-label"> =</label>
                <input type="text" class="form-control-res" id="res-value5" name="res"><br>
            </form>
            <label class="button-wrapper" id="train-button">
                Train
                <input type="button" onclick=trainRequest()>
            </label>
        </div>
        <div class="predict-train-interface" id="predict">
            <form class="predict-train-form" id="xy-form-predict">
                <label for="x-value" class="x-val-label"> x </label>
                <input type="text" class="form-control-x" id="x-value" name="x">

                <label for="y-value" class="y-val-label"> y </label>
                <input type="text" class="form-control-y" id="y-value" name="y">
            </form>
            <label class="button-wrapper" id="submit-button">
                Predict
                <input type="submit" onclick=predictRequest()>
            </label>
            <div class ="predict-result-wrapper" id ="predict-result-wrapper">
                =
                <output class="form-control-res" id="res-value-out" name="res-value" for="x-value y-value"></output>
            </div>
        </div>



    </div>

    <div class="col-right">
        <div id="drawflow" ondrop="drop(event)" ondragover="allowDrop(event)">
            <div class="btn-clear" onclick="editor.clear()">
                Clear
            </div>
            <div class="btn-lock">
                <i id="lock" class="fas fa-lock" onclick="editor.editor_mode='fixed'; changeMode('lock');"></i>
                <i id="unlock" class="fas fa-lock-open" onclick="editor.editor_mode='edit'; changeMode('unlock');" style="display: none;"></i>
            </div>
            <div class="bar-zoom">
                <i class="fas fa-search-minus" onclick="editor.zoom_out()"></i>
                <i class="fas fa-search" onclick="editor.zoom_reset()"></i>
                <i class="fas fa-search-plus" onclick="editor.zoom_in()"></i>
            </div>
        </div>
    </div>

    <div class="layer-data" id="layer-data">
        Coming soon!
    </div>
</div>

<div class="terminal" id="terminal">
    Coming soon!
</div>

<div class="metrics" id="metrics">
    Coming soon!
</div>





<!-- JS scripts -->
<script>
    var user_id = null
    var model_id = null
    const address = "localhost:3000"

    let last_selected_layer_id = null      // db id последнего выбранного слоя
    let last_selected_connection_id = null
    let train_status = null

    var layers_id_queue = new Array();           // Queue for layer's id from DB
    var connections_id_queue = new Array();      // Same queue for connection's id

    // Функция, позволяющая вызывать другю функцию через ms времени
    const delay = async (ms) => await new Promise(resolve => setTimeout(resolve, ms));
    setup()

    async function setup() {

        try {
            const actionWithDelay = delay(300).then(() => addUser());
            const actionWithDelay2 = delay(500).then(() => addModel());

            let ObjData = {
                type: "Data",
                parameters: "inputs=0;outputs=1;width=2;height=4"
            };

            let ObjOutput = {
                type: "Output",
                parameters: "inputs=1;outputs=0;width=1;height=4"
            }

            //TODO добавить output'y id и параметры

            const add_data_response = delay(900).then(() => addLayer(ObjData));
            const add_data_id = delay(1600).then(() => editor.updateNodeDataFromId(1, { DBID: layers_id_queue.pop() }));
            const add_output_response = delay(2100).then(() => addLayer(ObjOutput));
            const add_output_id = delay(2500).then(() => editor.updateNodeDataFromId(2, { DBID: layers_id_queue.pop() }));

            const actionWithDelay3 = delay(2000).then(() => console.log(`Setup completed successfully. \nUser ID: ${user_id} \nModel ID: ${model_id}`))

        }
        catch (err) {
            console.log(`Something went wrong during setup :( \nError: ${err}`)
        }

    }
</script>


<!--Взаимодействие html и js-->
<script>
    function showMode(event){
        var all = document.querySelectorAll(".menu ul li");
        var modes = document.querySelectorAll("div.home, div.constructor, div.terminal, div.metrics")
        for (var i = 0; i < all.length; i++) {
            all[i].classList.remove("selected");
            modes[i].style.display = 'none';
        }
        event.target.classList.add("selected");
        document.getElementById(event.target.id.split("-")[1]).style.display = 'flex'
    }
    function showProfile(){
        var prf = document.getElementById("profile")
        if(prf.style.display == 'grid')
            prf.style.display = 'none'
        else
            prf.style.display = 'grid'
    }
    function onTrainShowPredict(training_successful){
        training_successful ? document.getElementById("predict").style.display = 'block'
            : document.getElementById("predict").style.display = 'none'
    }
    function train(){
        //todo
        //Проверить, что соединено с output и data
        var training_status = true
        showBuildNotification(training_status)
        onTrainShowPredict(training_status)
    }
    function onPredictShowResult(res){
        //todo
        document.getElementById("res-value-out").innerHTML = res
        document.getElementById("predict-result-wrapper").style.textAlign = 'center'
        document.getElementById("predict-result-wrapper").style.display = 'block'


    }
    function predict(){
        //todo
        var res = 0
        onPredictShowResult(res)
    }
    function getLayerInfoFromDB(id){
        //todo
        //взаимодействие с сервером, бд
    }
    function showLayerInfo(id){
        const data = getLayerInfoFromDB(id);
        document.getElementById("layer-data").style.display = 'block'
    }
    function hideLayerInfo(){
        document.getElementById("layer-data").style.display = 'none'
    }
    function changeTheme(){
        var checkbox = document.getElementById("day-night-checkbox-id")
        var root = document.documentElement.style
        if(checkbox.checked){
            root.setProperty('--color0', '#00a1b0')
            root.setProperty('--color1', '#01606c')
            root.setProperty('--color2', '#00f4ff')
            root.setProperty('--color3', '#00a7ab')
            root.setProperty('--color4', '#1e838a')
            root.setProperty('--background0', '#3d3d42')
            root.setProperty('--background1', '#4b5760')
            root.setProperty('--background2', '#343e4f')
            root.setProperty('--background3', '#959daf')
            root.setProperty('--background4', '#dedede')
            root.setProperty('--border-color', '#ffffff')
            root.setProperty('--background-color', '#0c1017')
            root.setProperty('--background-box-title', '#424242')
            root.setProperty('--gradient-color', '#2b2f34')
            root.setProperty('--text-color', '#ffffff')
            root.setProperty('--notification-color-success', '#156532')
            root.setProperty('--notification-color-success-border', '#3fd778')
            root.setProperty('--notification-color-fail', '#702626')
            root.setProperty('--notification-color-fail-border', '#f66262')
        }
        else{
            root.setProperty('--color0', '#ccfcff')
            root.setProperty('--color1', '#b2f9fd')
            root.setProperty('--color2', '#009ba2')
            root.setProperty('--color3', '#25c6ce')
            root.setProperty('--color4', '#20b6be')
            root.setProperty('--background0', '#e1e1e1')
            root.setProperty('--background1', '#b5bdc4')
            root.setProperty('--background2', '#62738c')
            root.setProperty('--background3', '#303744')
            root.setProperty('--background4', '#282828')
            root.setProperty('--border-color', '#000000')
            root.setProperty('--background-color', '#ffffff')
            root.setProperty('--background-box-title', '#d0d0d0')
            root.setProperty('--gradient-color', '#aebcd2')
            root.setProperty('--text-color', '#000000')
            root.setProperty('--notification-color-success', '#3fd778')
            root.setProperty('--notification-color-success-border', '#156532')
            root.setProperty('--notification-color-fail', '#f66262')
            root.setProperty('--notification-color-fail-border', '#702626')
        }
    }

    // Notifications
    const buildSuccessful = () => {
        const success = document.getElementById('success');
        success.style.display = 'block';
        success.innerHTML = '<div style="font-weight: bold; font-size: 23px">Success!</div>Successfully built and trained the neural network';
        setTimeout(() => {
            success.style.display = 'none';
        }, 3 * 1000);
    };
    const buildUnsuccessful = () => {
        const error = document.getElementById('error');
        error.style.display = 'block';
        error.innerHTML = '<div style="font-weight: bold; font-size: 23px">Error!</div>Failed to build the neural network';
        setTimeout(() => {
            error.style.display = 'none';
        }, 3 * 1000);
    }
    const showBuildNotification = (build_status) => {
        build_status ? buildSuccessful() : buildUnsuccessful();
    }
</script>





<!--Работа с Drawflow-->
<script>
    class CustomDrawflow extends Drawflow {
        constructor(id) {
            super(id);
        }
        removeNodeId(id) {
            var nodeClassFromId = this.getNodeFromId(id.slice(5)).class;
            if(nodeClassFromId === "special"){
                return
            }
            var r = confirm("Delete this layer?");
            if (r === true) {
                super.removeNodeId(id)
            }
        }
        clear() {
            super.clear()
            //очистить бд?
            this.addNode("Data", 0, 1, 300, 363, "special", {}, '<div class="title-box"><i class="fas fa-file-signature"></i> Data </div>')
            this.addNode("Output", 1, 0, 700, 363, "special", {}, '<div class="title-box"><i class="fas fa-file-signature"></i> Output </div>')
        }
        contextmenu(e){
            if(this.node_selected)
                showLayerInfo(this.node_selected.id)
            super.contextmenu(e)
        }
        click(e){
            hideLayerInfo()
            super.click(e)
        }
    }

    var id = document.getElementById("drawflow");
    const editor = new CustomDrawflow(id);
    editor.start();
    editor.addNode("Data", 0, 1, 300, 363, "special", {}, '<div class="title-box"><i class="fas fa-file-signature"></i> Data </div>')
    editor.addNode("Output", 1, 0, 700, 363, "special", {}, '<div class="title-box"><i class="fas fa-file-signature"></i> Output </div>')
    /*editor.drawflow = {
        drawflow: {
            Home: {
                data: {
                    "1": {
                        id: 1, name: "Data", data: {}, class: "special",
                        html: '<div class="title-box"><i class="fas fa-file-signature"></i> Data </div>',
                        typenode: false,
                        inputs: {},
                        outputs: { output_1: {connections: []}},
                        pos_x: 300, pos_y: 363
                    },
                    "2": {
                        id: 2, name: "Output", data: {}, class: "special",
                        html: '<div class="title-box"><i class="fas fa-file-signature"></i> Output </div>',
                        typenode: false,
                        inputs: { input_1: {connections: []}},
                        outputs: { },
                        pos_x: 700, pos_y: 363
                    }
                },
            },
        }
    };*/

    // Events!
    editor.on("nodeCreated", function (id) {      // Добавление нового слоя (блока)
        console.log("Node created " + id);
        let delay_test = delay(500).then(() => editor.updateNodeDataFromId(id, { DBID: layers_id_queue.pop() }))
        let delayed_log = delay(700).then(() => console.log(Object.values(editor.getNodeFromId(id)['data'])[0]))

    });
    editor.on("nodeRemoved", function (id) {
        console.log("Node removed " + id);
        let layer_to_delete = {
            id: last_selected_layer_id
        };
        deleteLayer(layer_to_delete)
    });
    editor.on("nodeSelected", function (id) {
        console.log("selected layer DBID: " + Object.values(editor.getNodeFromId(id)['data'])[0]); // DBID -- database id
        last_selected_layer_id = Object.values(editor.getNodeFromId(id)['data'])[0];               // database id of last selected layer
    });
    editor.on("moduleCreated", function (name) {
        console.log("Module Created " + name);
    });
    editor.on("moduleChanged", function (name) {
        console.log("Module Changed " + name);
    });
    editor.on("connectionCreated", function(info) {

    });
    editor.on("connectionCreated", function (connection) {
        console.log("Connection created");

        let dbid_from = Object.values(editor.getNodeFromId(connection.output_id)['data'])[0];  // id from database
        let dbid_to = Object.values(editor.getNodeFromId(connection.input_id)['data'])[0];

        let layers_connection = {
            layer_from: dbid_from,  // id from database
            layer_to: dbid_to
        };

        addConnection(layers_connection)

        let connection_id = null;   // "<connection ID in database>;<connected layer ID in database>"
        let delayed_assign = delay(300).then(() => connection_id = `${connections_id_queue.pop()};${dbid_to}`)
        let delayed_log = delay(550).then(() => console.log(`new connection id: ${connection_id}`))

        if (Object.values(editor.getNodeFromId(connection.output_id)['data'])[1] == undefined) {
            let delayed_update = delay(500).then(() => editor.updateNodeDataFromId(connection.output_id, { DBID: dbid_from, Connections: [connection_id]}))
            let delayed_log = delay(750).then(() => console.log(Object.values(editor.getNodeFromId(connection.output_id)['data'])[1]))
        }
        else {
            let current_connections =  Object.values(editor.getNodeFromId(connection.output_id)['data'])[1]
            let delayed_push = delay(500).then(() => current_connections.push(connection_id))
            let delayed_update = delay(750).then(() => editor.updateNodeDataFromId(connection.output_id, { DBID: dbid_from, Connections: current_connections})) // Good

            let delayed_log = delay(1000).then(() => console.log(Object.values(editor.getNodeFromId(connection.output_id)['data'])[1]))
        }
        //console.log(connection); // useless info

        /*
        const nodeInfoIn = editor.getNodeFromId(connection.input_id);
        if(nodeInfoIn.inputs[connection.input_class].connections.length > 1) {
            const removeConnectionInfo = nodeInfoIn.inputs[connection.input_class].connections[0];
            editor.removeSingleConnection(removeConnectionInfo.node, connection.input_id, removeConnectionInfo.input, connection.input_class);
        }
        const nodeInfoOut = editor.getNodeFromId(connection.output_id);
        if(nodeInfoOut.outputs[connection.output_class].connections.length > 1) {
            const removeConnectionInfo = nodeInfoOut.outputs[connection.output_class].connections[0];
            editor.removeSingleConnection(connection.output_id, removeConnectionInfo.node, connection.output_class, removeConnectionInfo.output);
        }
         */
    });
    editor.on("connectionRemoved", function (connection) {
        console.log("Connection removed");

        let layer_to_db_id = Object.values(editor.getNodeFromId(connection.input_id)['data'])[0]
        let layer_from_db_id = Object.values(editor.getNodeFromId(connection.output_id)['data'])[0]
        let list_of_connections = Object.values(editor.getNodeFromId(connection.output_id)['data'])[1]

        let cur_elem_index = null
        let parsed_connection = null
        let i = 0;
        while (i < list_of_connections.length) {
            parsed_connection = list_of_connections[i].split(';')
            console.log(parsed_connection[0] + "___" + parsed_connection[1])
            if (parsed_connection[1] == layer_to_db_id) {
                let connection_id = {
                    id: parsed_connection[0]
                }
                deleteConnection(connection_id)
                break;
            }

            i++;
        }
        list_of_connections.splice(cur_elem_index, 1) // deletes connection from list
        editor.updateNodeDataFromId(connection.output_id, { DBID: layer_from_db_id, Connections: list_of_connections})
        console.log(list_of_connections)

    });
    editor.on("mouseMove", function (position) {
        //console.log("Position mouse x:" + position.x + " y:" + position.y);
    });
    editor.on("nodeMoved", function (id) {
        console.log("Node moved " + id);
    });
    editor.on("zoom", function (zoom) {
        console.log("Zoom level " + zoom);
    });
    editor.on("translate", function (position) {
        //console.log("Translate x:" + position.x + " y:" + position.y);
    });
    editor.on("addReroute", function (id) {
        console.log("Reroute added " + id);
    });
    editor.on("removeReroute", function (id) {
        console.log("Reroute removed " + id);
    });


    /* DRAG EVENT */
    /* Mouse and Touch Actions */
    var elements = document.getElementsByClassName("drag-drawflow");
    for (var i = 0; i < elements.length; i++) {
        elements[i].addEventListener("touchend", drop, false);
        elements[i].addEventListener("touchmove", positionMobile, false);
        elements[i].addEventListener("touchstart", drag, false);
    }
    var mobile_item_selec = "";
    var mobile_last_move = null;
    function positionMobile(ev) {
        mobile_last_move = ev;
    }
    function allowDrop(ev) {
        ev.preventDefault();
    }
    function drag(ev) {
        if (ev.type === "touchstart") {
            mobile_item_selec = ev.target
                .closest(".drag-drawflow")
                .getAttribute("data-node");
        } else {
            ev.dataTransfer.setData("node", ev.target.getAttribute("data-node"));
        }
    }
    function drop(ev) {
        if (ev.type === "touchend") {
            var parentdrawflow = document
                .elementFromPoint(
                    mobile_last_move.touches[0].clientX,
                    mobile_last_move.touches[0].clientY
                )
                .closest("#drawflow");
            if (parentdrawflow != null) {
                addNodeToConstructor(
                    mobile_item_selec,
                    mobile_last_move.touches[0].clientX,
                    mobile_last_move.touches[0].clientY
                );
            }
            mobile_item_selec = "";
        } else {
            ev.preventDefault();
            var data = ev.dataTransfer.getData("node");
            addNodeToConstructor(data, ev.clientX, ev.clientY);
        }
    }

    // Добавление слоя (блока)
    function addNodeToConstructor(name, pos_x, pos_y) {
        console.log("added node")

        if (editor.editor_mode === "fixed")
            return false;
        pos_x =
            pos_x *
            (editor.precanvas.clientWidth /
                (editor.precanvas.clientWidth * editor.zoom)) -
            editor.precanvas.getBoundingClientRect().x *
            (editor.precanvas.clientWidth /
                (editor.precanvas.clientWidth * editor.zoom));
        pos_y =
            pos_y *
            (editor.precanvas.clientHeight /
                (editor.precanvas.clientHeight * editor.zoom)) -
            editor.precanvas.getBoundingClientRect().y *
            (editor.precanvas.clientHeight /
                (editor.precanvas.clientHeight * editor.zoom));

        switch (name) {
            case "linear":
                var linear = `<div class="layer"><i class="fab moduleA"></i> Linear</div>`;
                editor.addNode("linear", 1, 1, pos_x, pos_y, "linear", {}, linear);
                let Obj1 = {
                    type: "Linear",
                    parameters: "inputs=1;outputs=1;inFeatures=2;outFeatures=2" //TODO
                };
                addLayer(Obj1)
                break;

            case "relu":
                var relu = `<div class="layer"><i class="fab moduleA"></i> ReLU</div>`;
                editor.addNode("relu", 1, 1, pos_x, pos_y, "relu", {}, relu);
                let Obj2 = {
                    type: "Relu",
                    parameters: "inputs=1;outputs=1" //TODO
                };
                addLayer(Obj2)
                break;

                /*
            case "sigmoid":
                var sigmoid = `<div class="layer"><i class="fab Module C "></i> Sigmoid</div>`;
                editor.addNode("Sigmoid", 1, 1, pos_x, pos_y, "Sigmoid", {}, sigmoid);
                let Obj3 = {
                    type: "Sigmoid",
                    parameters: "input_1=1 output_1=1"
                };
                addLayer(Obj3)
                break;
                 */

            default:
        }
    }

    var transform = "";
    function showpopup(e) {
        e.target.closest(".drawflow-node").style.zIndex = "9999";
        e.target.children[0].style.display = "block";

        transform = editor.precanvas.style.transform;
        editor.precanvas.style.transform = "";
        editor.precanvas.style.left = editor.canvas_x + "px";
        editor.precanvas.style.top = editor.canvas_y + "px";

        editor.editor_mode = "fixed";
    }

    function closemodal(e) {
        e.target.closest(".drawflow-node").style.zIndex = "2";
        e.target.parentElement.parentElement.style.display = "none";
        editor.precanvas.style.transform = transform;
        editor.precanvas.style.left = "0px";
        editor.precanvas.style.top = "0px";
        editor.editor_mode = "edit";
    }

    function changeMode(option) {
        //console.log(lock.id);
        if (option == "lock") {
            lock.style.display = "none";
            unlock.style.display = "block";
        } else {
            lock.style.display = "block";
            unlock.style.display = "none";
        }
    }
</script>





<!--JSON requests handling-->
<script>
    async function sendJson(sending_object, url) {

        const resp = await fetch(url, {
            method: 'POST',
            mode: 'cors',
            headers: {'content-type': 'application/json'},
            body: JSON.stringify(sending_object)
        })

        return await resp.text()
    }

    function addLayer(sending_obj) {
        (async() => { layers_id_queue.unshift(await sendJson(sending_obj, `http://${address}/add_layer/${user_id}/${model_id}`)) } )()
    }

    function addConnection(layers_connection) {
        (async() => { connections_id_queue.unshift(await sendJson(layers_connection, `http://${address}/add_connection/${user_id}/${model_id}`)) } )()
    }

    function addUser() {
        let temp_json = {
            type: "Not empty JSON"
        };

        (async() => { user_id = await sendJson(temp_json, `http://${address}/add_user`) } )()
    }

    function addModel() {
        let temp_json = {
            name: "test_post_model_1"             // custom model name ... coming soon
        };

        (async() => { model_id = await sendJson(temp_json, `http://${address}/add_model/${user_id}`) })()
    }

    function deleteLayer(sending_object) {
        (async() => { await sendJson(sending_object, `http://${address}/delete_layer/${user_id}/${model_id}`) } )()
    }

    function deleteConnection(sending_object) {
        (async() => { last_selected_connection_id = await sendJson(sending_object, `http://${address}/delete_connection/${user_id}/${model_id}`) } )()
        console.log(`Deleted connection with DBID: ${sending_object.id}`)
    }

    function trainRequest() {
        /*
        const obj = {
            "0" : [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
            "1" : [1, 1, 1, 1, 1]
        };
         */
        var form_data = buildTrainData(document.querySelector("#xy-form-train"));

        (async() => { train_status = await sendJson(form_data, `http://${address}/train/${user_id}/${model_id}/0`) } )()

        let delayed_train_result = delay(2000).then(() => {
            showBuildNotification(train_status)
            onTrainShowPredict(train_status)
        })

    }

    function predictRequest() {
        const form_data = buildJsonFormData(document.querySelector("#xy-form-predict"))
        console.log(form_data)

        for(let i = 0; i < form_data.length; i++) {
            let obj = form_data[i];

            console.log(obj);
        }

        var result
        (async() => { result = await sendJson(form_data, `http://${address}/predict/${user_id}/${model_id}`) } )()
        let delayed_result = delay(1000).then(() => onPredictShowResult(result))
    }

    function buildJsonFormData(form) {
        const jsonFormData = {}
        for (const pair of new FormData(form)) {
            jsonFormData[pair[0]] = pair[1]
        }
        return jsonFormData
    }

    function buildTrainData(form) {
        let input = []
        let output = []
        const jsonFormData = {}

        for (const pair of new FormData(form)) {
            if (pair[0] == "res") {
                output.push(pair[1])
            }
            else {
                input.push(pair[1])
            }
        }

        jsonFormData["0"] = input;       // 0 - id Data layer
        jsonFormData["1"] = output;      // 1 - id Output layer
        console.log(jsonFormData)
        return jsonFormData
    }

    async function submitForm(e, form) {
        e.preventDefault()

        const btnSubmit = document.getElementById("btnSubmit")
        btnSubmit.disabled = true
        setTimeout(() => btnSubmit.disabled = false, 2000)

        const jsonFormData = buildJsonFormData(form)
        const headers = buildHeaders()
        const response = await performPostHttpRequest(`http://${address}/predict/1/1`, headers, jsonFormData)

        if (response) {
            console.log("Success request")
        } else {
            console.log("An error occured")
        }
    }

    // event listener
    const xy_form = document.querySelector("#xy-form-predict");
    if (xy_form) {
        xy_form.addEventListener("submit", function (e) {
            submitForm(e, this);
        });
    }
</script>

</body>
</html>
